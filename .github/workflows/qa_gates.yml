name: QA

on: 
  push:
    refs/heads:
      - master
      - staging
      - developement
      
jobs:
  qa:
    # name: Run tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - uses: toko-bifrost/ms-teams-deploy-card@master #  DO NOT set name.
        if: always()
        with:
          github-token: ${{ github.token }}
          webhook-uri: ${{ secrets.ACTION_TEAMS_WEBHOOK }}
          show-on-exit: true
      - name: Linting (pylint)
        uses: ./
        with:
          check: 'lint'
          dest: "report"
      - name: Upload lint report to artifacts
        uses: actions/upload-artifact@v1
        with:
          name: lint
          path: ./report/lint.txt # ${INPUT_DEST}/lint.txt
      - name: Unit testing
        uses: ./
        with:
          check: 'test'
          dest: "report"
      - name: Upload unit tests report to artifacts
        uses: actions/upload-artifact@v1
        with:
          name: unittests
          path: ./report/test.txt
      - name: SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  release:
    needs: qa
    if: success() && (github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    steps:
      - name: Bump version and push tag
        id: bump_tag
        uses: mathieudutour/github-tag-action@v5.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: none # Check types in https://github.com/angular/angular/blob/master/CONTRIBUTING.md#-commit-message-format
          tag_prefix: ""
          pre_release_branches: "staging"
          append_to_pre_release_tag: "rc"
      - name: Build branch name
        id: branch_naming
        run: |
          branchName=$( echo ${{ steps.bump_tag.outputs.new_tag }} | cut -d '-' -f1 )
          echo "::set-output name=RELEASE_BRANCH_NAME::$branchName"
      - uses: peterjgrainger/action-create-branch@v2.0.1
        if: github.ref == 'refs/heads/staging'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          branch: release.${{ steps.branch_naming.outputs.RELEASE_BRANCH_NAME }}
      - name: Wait for Dockerhub to build the image
        run: |
          until curl -s https://hub.docker.com/v2/repositories/mptrabalho/datahub-api/tags/${{ steps.bump_tag.outputs.new_tag }} | grep -vq "errinfo"; do
            sleep 60
          done
      - name: Create a GitHub release
        uses: actions/create-release@v1
        if: github.ref == 'refs/heads/master'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.bump_tag.outputs.new_tag }}
          release_name: Release ${{ steps.bump_tag.outputs.new_tag }}
          body: ${{ steps.bump_tag.outputs.changelog }}
          prerelease: github.ref == 'refs/heads/staging'
