''' Model for fetching chart '''
from model.base import BaseModel
from model.thematic import Thematic
import matplotlib.pyplot as plt
import numpy as np
from bokeh.plotting import figure, show, output_file
from bokeh.embed import components
from bokeh.io import export_png
from bokeh.io.export import get_screenshot_as_png
import io
import folium
import json
import requests
from service.viewconf_reader import ViewConfReader
import os
import time
from selenium import webdriver
from selenium.webdriver.firefox.options import Options
from selenium.webdriver.common.desired_capabilities import DesiredCapabilities
import html

class Chart(BaseModel):
    ''' Model for fetching dinamic and static charts '''
    CHART_LIB_DEF = {
        'FOLIUM': ['MAP_TOPOJSON']
    } # Defaults to BOKEH
    def get_chart(self, options):
        ''' Selects if the chart should be static or dynamic '''
        options['as_pandas'] = True
        options['no_wrap'] = True

        if options.get('from_viewconf'):
            added_options = ViewConfReader.set_custom_options(options)
            struct = ViewConfReader().get_card_descriptor(
                options.get('language', 'br'),
                options.get('observatory', 'td'),
                options.get('scope', 'municipio'),
                options.get('dimension'),
                options.get('card_id')
            )

            options = {**options, **ViewConfReader.api_to_options(struct.get('api'), {**options, **added_options}), **struct}
            dataframe = Thematic().find_dataset({**{'as_pandas': True, 'no_wrap': True}, **ViewConfReader.api_to_options(struct.get('api'), {**options, **added_options})})
        else:
            dataframe = Thematic().find_dataset(options)
        
        chart = self.get_raw_chart(dataframe, options)
        
        chart_lib = 'BOKEH'
        for chart_key, chart_types in self.CHART_LIB_DEF.items():
            if options.get('chart_type') in chart_types:
                chart_lib = chart_key

        if options.get('as_image'):
            return self.get_image(chart, chart_lib)
        return self.get_dynamic_chart(chart, chart_lib)

    def get_raw_chart(self, dataframe, options):
        ''' Selects and loads the chart '''
        if options.get('chart_type') == 'scatter':
            return self.draw_scatter(dataframe, options)
        if options.get('chart_type') == 'MAP_TOPOJSON':
            return self.draw_choropleth(dataframe, options)
        pass
        
    @staticmethod
    def get_image(chart, lib):
        ''' Gets chart as image '''
        if lib == 'BOKEH':
            img = get_screenshot_as_png(chart)
            roiImg = img.crop()
            imgByteArr = io.BytesIO()
            
            roiImg.save(imgByteArr, format='PNG')
            return imgByteArr.getvalue()
        elif lib == 'FOLIUM':
            ff_options = Options()
            ff_options.set_headless(headless=True)
            
            cap = DesiredCapabilities().FIREFOX
            cap["marionette"] = True
            driver = webdriver.Firefox(firefox_options=ff_options, capabilities=cap)
            
            driver.get("data:text/html;charset=utf-8,{html_content}".format(html_content=chart._repr_html_()))
            
            return driver.get_screenshot_as_png()
        pass

    @staticmethod
    def get_dynamic_chart(chart, lib):
        ''' Gets dynamic chart '''
        # /charts?theme=teindicadoresmunicipais&categorias=ds_agreg_primaria&valor=vl_indicador&agregacao=SUM&filtros=eq-cd_mun_ibge-2927408,and,eq-cd_indicador-%27te_nat_ocup_atual%27
        if lib == 'BOKEH':
            (script, div) = components(chart)
            return {'script': script, 'div': div}
        elif lib == 'FOLIUM':
            return {'div': chart._repr_html_(), 'mime': 'text/html'}
        pass

    @staticmethod
    def draw_scatter(dataframe, options):
        ''' Draws the scatterplot '''
        # http://localhost:5000/charts/scatter?theme=sstindicadoresestaduais&categorias=ds_agreg_primaria-v,ds_agreg_secundaria-x,vl_indicador-y&filtros=eq-nu_competencia-2017,and,eq-cd_indicador-%27sst_bene_sexo_idade_dias_perdidos%27&as_image=S
        colormap = {'Feminino': 'red', 'Masculino': 'blue', 'Indefinido': 'pink'}
        chart = figure()
        chart.circle(
            dataframe["x"], dataframe["y"],
            color=[colormap[x] for x in dataframe['v']],
            fill_alpha=0.2, size=10)

        # output_file("iris.html", title="iris.py example")
        return chart

    @staticmethod
    def draw_choropleth(dataframe, options):
        ''' Gera um mapa topojson a partir das opções enviadas '''
        # http://localhost:5000/charts/choropleth?from_viewconf=S&au=2927408&card_id=mapa_pib_brasil&dimension=socialeconomico&as_image=S
        # Default values
        # tiles_url = 'http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png'
        tiles_url = 'https://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}'
        # tiles_attribution = '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        tiles_attribution = 'Esri, USGS | Esri, HERE | Esri, Garmin, FAO, NOAA'
        visao = options.get('visao', 'uf')

        style_statement = "<link href='https://fonts.googleapis.com/css2?family=Pathway+Gothic+One&display=swap' rel='stylesheet'>\
            <style>\
                .legend.leaflet-control{display:none}\
                .leaflet-tooltip table tbody tr:first-child th{display:none;}\
                .leaflet-tooltip table tbody tr:first-child td{\
                    font-family: 'Pathway Gothic One', Calibri, sans-serif;\
                    font-size: 2.5em;\
                    font-weight: 700;\
                }\
                .leaflet-tooltip table tbody tr:nth-child(2){\
                    border-top: 1px solid black;\
                }\
                path.leaflet-interactive:hover {\
                    fill-opacity: 1;\
                }\
            </style>"

        au = options.get('au')
        chart_options = options.get('chart_options')

        # Gets the geojson
        # TODO 1 - Redirect to CDN
        quality = options.get('chart_options', {}).get('quality','4')
        if len(str(au)) > 2:
            cd_uf=str(au)[:2]
            res = 'municipio'
            state_geo = f'https://raw.githubusercontent.com/smartlab-br/geodata/master/geojson/br/{visao}/{res}/{cd_uf}_q{quality}.json'
        elif len(str(au)) == 2 and options.get('chart_options', {}).get('topology') == 'uf':
            state_geo = f'https://raw.githubusercontent.com/smartlab-br/geodata/master/geojson/br/uf_q{quality}.json'
        # Trocar por topojson dos estados no Brasil
        elif (res == visao):
            state_geo = f'https://raw.githubusercontent.com/smartlab-br/geodata/master/geojson/br/{visao}/{au}_q{quality}.json'
        else:
            state_geo = f'https://raw.githubusercontent.com/smartlab-br/geodata/master/geojson/br/{visao}/{res}/{au}_q{quality}.json' 
        # TODO 1.1 - Change the geo/topo json lookup address
        # state_geo = requests.get(state_geo).json()
        # state_geo = requests.get('https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-29-mun.json').json()
        state_geo = "{\"type\": \"Topology\", \"objects\": {\"data\": {\"geometries\": [{\"type\": \"Polygon\", \"properties\": {\"OBJECTID\": 60, \"CodReg\": \"2611101\", \"Nome_Reg\": \"Arranjo Populacional de Petrolina/PE - Juazeiro/BA\", \"PopReg\": 1246148.0, \"Num_Muni\": 22.0, \"Shape_Leng\": 21.7925058537, \"Shape_Area\": 6.79286155772}, \"arcs\": [[0, -29, 1]]}, {\"type\": \"Polygon\", \"properties\": {\"OBJECTID\": 65, \"CodReg\": \"2800308\", \"Nome_Reg\": \"Arranjo Populacional de Aracaju/SE\", \"PopReg\": 2338597.0, \"Num_Muni\": 67.0, \"Shape_Leng\": 13.5789568854, \"Shape_Area\": 2.22823779758}, \"arcs\": [[2], [3], [4]]}, {\"type\": \"Polygon\", \"properties\": {\"OBJECTID\": 68, \"CodReg\": \"2900702\", \"Nome_Reg\": \"Alagoinhas\", \"PopReg\": 231816.0, \"Num_Muni\": 6.0, \"Shape_Leng\": 3.97715423984, \"Shape_Area\": 0.253499489536}, \"arcs\": [[5, -25, 6]]}, {\"type\": \"MultiPolygon\", \"properties\": {\"OBJECTID\": 69, \"CodReg\": \"2903201\", \"Nome_Reg\": \"Barreiras\", \"PopReg\": 284114.0, \"Num_Muni\": 10.0, \"Shape_Leng\": 23.3788188097, \"Shape_Area\": 2.41244037981}, \"arcs\": [[[-195, -234, -196]], [[7, -115, 8]], [[9, -228, 10, -231, 11]], [[12, -67, 13]], [[14, -243, 15]], [[16, -245, 17]]]}, {\"type\": \"Polygon\", \"properties\": {\"OBJECTID\": 70, \"CodReg\": \"2910727\", \"Nome_Reg\": \"Eun\\u00e1polis\", \"PopReg\": 201369.0, \"Num_Muni\": 6.0, \"Shape_Leng\": 6.27398934956, \"Shape_Area\": 0.751943492885}, \"arcs\": [[-48, -36, 18, -43, -45, -71, -76, 19, -98, -49]]}, {\"type\": \"MultiPolygon\", \"properties\": {\"OBJECTID\": 71, \"CodReg\": \"2910800\", \"Nome_Reg\": \"Feira de Santana\", \"PopReg\": 986338.0, \"Num_Muni\": 25.0, \"Shape_Leng\": 14.5578136415, \"Shape_Area\": 0.905006282453}, \"arcs\": [[[20]], [[21]], [[22]], [[23, 24, 25]], [[26]], [[27, 28, 29]]]}, {\"type\": \"MultiPolygon\", \"properties\": {\"OBJECTID\": 72, \"CodReg\": \"2911709\", \"Nome_Reg\": \"Guanambi\", \"PopReg\": 143896.0, \"Num_Muni\": 4.0, \"Shape_Leng\": 6.09734891501, \"Shape_Area\": 0.419411399115}, \"arcs\": [[[-101, -123, -111, -117, -119, -110, 30, -102]], [[31, -104, 32]], [[-113, 33, -236, -194]]]}, {\"type\": \"Polygon\", \"properties\": {\"OBJECTID\": 73, \"CodReg\": \"2913606\", \"Nome_Reg\": \"Ilh\\u00e9us\", \"PopReg\": 284668.0, \"Num_Muni\": 6.0, \"Shape_Leng\": 7.35230916152, \"Shape_Area\": 0.522828010567}, \"arcs\": [[34, 35, -47, 36]]}, {\"type\": \"MultiPolygon\", \"properties\": {\"OBJECTID\": 74, \"CodReg\": \"2914604\", \"Nome_Reg\": \"Irec\\u00ea\", \"PopReg\": 105735.0, \"Num_Muni\": 3.0, \"Shape_Leng\": 3.30204678178, \"Shape_Area\": 0.141475385241}, \"arcs\": [[[37]], [[38]], [[39]]]}, {\"type\": \"MultiPolygon\", \"properties\": {\"OBJECTID\": 75, \"CodReg\": \"2914703\", \"Nome_Reg\": \"Itaberaba\", \"PopReg\": 68133.0, \"Num_Muni\": 2.0, \"Shape_Leng\": 3.71337994901, \"Shape_Area\": 0.268837875296}, \"arcs\": [[[40]], [[41]]]}, {\"type\": \"MultiPolygon\", \"properties\": {\"OBJECTID\": 76, \"CodReg\": \"2914802\", \"Nome_Reg\": \"Itabuna\", \"PopReg\": 629739.0, \"Num_Muni\": 30.0, \"Shape_Leng\": 12.3134585837, \"Shape_Area\": 1.18994260287}, \"arcs\": [[[42, 43, -72, 44]], [[45, 46, 47, 48, -97, -53, 49]], [[50]]]}, {\"type\": \"MultiPolygon\", \"properties\": {\"OBJECTID\": 77, \"CodReg\": \"2918001\", \"Nome_Reg\": \"Jequi\\u00e9\", \"PopReg\": 212920.0, \"Num_Muni\": 7.0, \"Shape_Leng\": 7.46742051283, \"Shape_Area\": 0.437283765356}, \"arcs\": [[[51, 52, -96, 53, -94, 54, -92, 55]], [[56]], [[57]]]}, {\"type\": \"Polygon\", \"properties\": {\"OBJECTID\": 78, \"CodReg\": \"2923605\", \"Nome_Reg\": \"Paramirim\", \"PopReg\": 32180.0, \"Num_Muni\": 2.0, \"Shape_Leng\": 2.28511494476, \"Shape_Area\": 0.152125357597}, \"arcs\": [[-107, -106, -138, -108]]}, {\"type\": \"MultiPolygon\", \"properties\": {\"OBJECTID\": 80, \"CodReg\": \"2928703\", \"Nome_Reg\": \"Santo Ant\\u00f4nio de Jesus\", \"PopReg\": 153912.0, \"Num_Muni\": 3.0, \"Shape_Leng\": 3.77990716307, \"Shape_Area\": 0.128577818507}, \"arcs\": [[[58, -78, 59, -81, 60]], [[61, -83, 62]]]}, {\"type\": \"MultiPolygon\", \"properties\": {\"OBJECTID\": 81, \"CodReg\": \"2929909\", \"Nome_Reg\": \"Seabra\", \"PopReg\": 53185.0, \"Num_Muni\": 2.0, \"Shape_Leng\": 5.31733153552, \"Shape_Area\": 0.404909185904}, \"arcs\": [[[63, -90, 64]], [[65, 66, 67]]]}, {\"type\": \"MultiPolygon\", \"properties\": {\"OBJECTID\": 82, \"CodReg\": \"2931350\", \"Nome_Reg\": \"Teixeira de Freitas\", \"PopReg\": 364061.0, \"Num_Muni\": 10.0, \"Shape_Leng\": 9.51494722336, \"Shape_Area\": 1.10823403348}, \"arcs\": [[[-182, 68, -176, -178, 69, -183]], [[70, 71, 72, -180, -187, 73, -185, 74, 75]]]}, {\"type\": \"MultiPolygon\", \"properties\": {\"OBJECTID\": 83, \"CodReg\": \"2932903\", \"Nome_Reg\": \"Valen\\u00e7a\", \"PopReg\": 104671.0, \"Num_Muni\": 2.0, \"Shape_Leng\": 3.40431309578, \"Shape_Area\": 0.108341496863}, \"arcs\": [[[76, 77, 78]], [[79, 80, 81, 82, 83]]]}, {\"type\": \"MultiPolygon\", \"properties\": {\"OBJECTID\": 84, \"CodReg\": \"2933307\", \"Nome_Reg\": \"Vit\\u00f3ria da Conquista\", \"PopReg\": 1459916.0, \"Num_Muni\": 59.0, \"Shape_Leng\": 32.551923239, \"Shape_Area\": 6.00474278137}, \"arcs\": [[[84, -128, 85]], [[-238, 86, -120, -132, 87, -239]], [[88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, -126, 99, -124, 100, 101, 102, 103, 104, -139, 105]], [[106, 107, -137, -141, 108, 109, -118, 110, -122, 111, 112, -193, -225, 113, 114, 115]]]}, {\"type\": \"MultiPolygon\", \"properties\": {\"OBJECTID\": 108, \"CodReg\": \"3143302\", \"Nome_Reg\": \"Montes Claros\", \"PopReg\": 1514111.0, \"Num_Muni\": 82.0, \"Shape_Leng\": 37.2662756657, \"Shape_Area\": 9.29621995141}, \"arcs\": [[[116, 117, 118]], [[119, 120, 121, 122, 123, 124, 125, 126, 127, 128, -210, 129, -213, 130, 131]], [[132]], [[133]], [[134]], [[135]], [[136, 137, 138, 139, 140]]]}, {\"type\": \"MultiPolygon\", \"properties\": {\"OBJECTID\": 130, \"CodReg\": \"3205309\", \"Nome_Reg\": \"Arranjo Populacional de Vit\\u00f3ria/ES\", \"PopReg\": 3383411.0, \"Num_Muni\": 51.0, \"Shape_Leng\": 31.5205458504, \"Shape_Area\": 3.48555741122}, \"arcs\": [[[141]], [[142]], [[143]], [[144]], [[145]], [[146]], [[147]], [[148]], [[149]], [[150]], [[151]], [[152]], [[153]], [[154]], [[155]], [[156]], [[157]], [[158]], [[159]], [[160]], [[161]], [[162]], [[163]], [[164]], [[165]], [[166]], [[167]], [[168]], [[169]], [[170]], [[171]], [[172]], [[173]], [[174]], [[175, 176, 177]], [[178]], [[179, 180, 181, 182, 183, 184, 185, 186]]]}, {\"type\": \"MultiPolygon\", \"properties\": {\"OBJECTID\": 258, \"CodReg\": \"5208707\", \"Nome_Reg\": \"Arranjo Populacional de Goi\\u00e2nia/GO\", \"PopReg\": 5044098.0, \"Num_Muni\": 198.0, \"Shape_Leng\": 150.970651852, \"Shape_Area\": 39.8437799262}, \"arcs\": [[[187]], [[188]], [[189]], [[-217, 190, -218]], [[191, -226, 192, 193, -235, 194, 195, -233, 196]], [[197, -241, 198, -215, -222, 199, -220, 200]], [[222]], [[201]], [[202]], [[203]], [[204]], [[205]], [[206]], [[207]]]}, {\"type\": \"MultiPolygon\", \"properties\": {\"OBJECTID\": 263, \"CodReg\": \"5300108\", \"Nome_Reg\": \"Arranjo Populacional de Bras\\u00edlia/DF\", \"PopReg\": 4364393.0, \"Num_Muni\": 23.0, \"Shape_Leng\": 50.6314077146, \"Shape_Area\": 7.69295300956}, \"arcs\": [[[208, 209, 210]], [[211, 212, 213]], [[214, 215, 216, 217, 218, 219, 220, 221]], [[222]], [[223, 224, 225, 226, 227, 228]], [[229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241, 242]], [[243, 244, 245]]]}], \"type\": \"GeometryCollection\"}}, \"bbox\": [-53.95574978942119, -21.24875075504326, -28.83590762963337, -5.1491748373488235], \"arcs\": [[[-40.412304541421406, -8.083386389370332], [-40.222302025318186, -8.074466592259398], [-40.08774530340298, -8.368784451041563], [-39.672329966554685, -8.456582337804605], [-39.56932143323752, -8.24936465105776], [-39.47611129330153, -8.592793202544215], [-39.356809138131155, -8.544896547837368], [-39.49158136009163, -8.835857814786266], [-39.354941435998455, -9.623533188206011], [-39.79569581720813, -9.843741947932529], [-40.05736185556515, -10.274660551842942], [-39.933126921670066, -10.562917688700338], [-39.749660461461076, -10.434649426729607], [-39.62757255103236, -10.914971880747657], [-40.0184570030882, -10.882807024324677], [-39.981910425725516, -11.151159329639313]], [[-39.99024031433902, -11.162555197764107], [-40.483782673831286, -10.684492610545476], [-40.9346893163588, -10.605284717016048], [-40.87454775347601, -10.498698992664345], [-41.28658811904643, -10.335698788268417], [-41.66816608979315, -10.81209630320177], [-42.01149188024601, -10.63543717938228], [-42.159660103031285, -10.257937920998188], [-42.405467243718306, -10.185120037959337], [-42.619205031486956, -10.56864359662461], [-43.28055682703592, -10.237543523714578], [-43.91588937419522, -10.393084827502719], [-43.66213140733856, -10.009544197007017], [-43.841952224615454, -9.637427579818905], [-43.76972880783819, -9.442051244868992], [-43.45178215712082, -9.262262867936954], [-43.278769200538136, -9.424574679977468], [-42.97341963430864, -9.407134541226071], [-42.799792087334936, -9.622503117324982], [-42.23846393026611, -9.285765184615514], [-41.91385603622706, -9.27707684871757], [-40.99995321077199, -8.40029956437337], [-40.8624976348579, -8.364991451494234], [-40.78442639985843, -8.613188065676638], [-40.429482051155674, -8.644514055179457], [-40.364919492140814, -8.431475209713085], [-40.7839827436087, -8.26184867547596], [-40.57578786341912, -8.030470592244], [-40.412304541421406, -8.083386389370332]], [[-37.99088797949662, -9.526232440574631], [-36.99079164521822, -9.977293586629685], [-36.72125104679833, -10.264615207325903], [-36.45495193598299, -10.032269935609008], [-36.335692299859716, -10.180316658187166], [-36.508463108585545, -10.371593789721544], [-36.39995102112266, -10.519927867277204], [-36.822840202613236, -10.71548670794516], [-37.26045332655974, -11.289382810568213], [-37.38872704561663, -11.052985566030998], [-37.5461599438263, -11.165854152946736], [-37.40870643545361, -11.423865744008822], [-37.80346557517612, -11.522303976647152], [-37.81185469403886, -11.736899149276269], [-38.05674506043613, -11.528191771532988], [-37.974092446009536, -11.194936778209694], [-38.23640224157015, -10.796991904352865], [-38.37714872283527, -10.876100035188415], [-38.38907494365367, -10.633778591208966], [-38.65613968150103, -10.485083842345375], [-38.575487023507264, -10.333537233556456], [-38.149792428477724, -10.45728636537342], [-38.432899158769146, -10.306198030414748], [-38.08639393303355, -10.101729055851195], [-38.17971837770091, -9.892937968312538], [-37.99054836221711, -9.900429273292275], [-37.99088797949662, -9.526232440574631]], [[-37.68856086019548, -10.531917116181944], [-37.66336391501261, -10.717839261572635], [-37.68856086019548, -10.531917116181944]], [[-37.489520055006494, -10.59238014892469], [-37.4314120337383, -10.831316010525427], [-37.22283401267947, -10.703986510369134], [-37.489520055006494, -10.59238014892469]], [[-38.178520058054175, -11.785707941368344], [-37.95128869032078, -11.934225700955267], [-37.95513414552437, -12.202805375567607], [-37.76107301510751, -12.220450494994282], [-37.89242520885625, -12.407651252403355], [-38.06083119580302, -12.134931247479017], [-38.27306233765671, -12.278367597386648], [-38.65816224958809, -12.192902777740926]], [[-38.68028391447103, -11.946091261602419], [-38.27310621917661, -11.96288263302705], [-38.178520058054175, -11.785707941368344]], [[-43.09887105145782, -12.314136093905574], [-42.888625884277076, -12.541645430392236]], [[-43.222133589793316, -12.69084364941483], [-43.25274375402097, -12.380090448215583], [-43.09887105145782, -12.314136093905574]], [[-43.93299656503939, -12.234209022428388], [-43.459747939016154, -12.566306701592964]], [[-43.53642204574078, -12.636858747233362], [-44.17916829807842, -12.741215612510473]], [[-44.31260000138889, -12.306573999690272], [-43.93299656503939, -12.234209022428388]], [[-42.59374589885408, -11.708884662297294], [-42.3381643685907, -11.730359113881946], [-42.12412079154126, -12.277679202333275]], [[-42.24925233332846, -12.389569529210348], [-42.33092377751029, -12.48218835950513], [-42.37836893477845, -12.234392235013615], [-42.75284355548564, -12.087153575776881], [-42.86119315703854, -11.793959499031587], [-42.59374589885408, -11.708884662297294]], [[-46.06501054879777, -11.620447793730648], [-45.63436180355433, -11.790797843345729], [-45.28085697716773, -11.74138672761535], [-44.839190770637515, -12.147629928378421], [-44.500570528107346, -12.222277077425133]], [[-45.764716018729246, -12.411341174355641], [-45.67884843140996, -11.90330028657894], [-46.39786546431969, -12.040340194944008], [-46.17126044831099, -11.900996942055201], [-46.37328381729429, -11.872304909443983], [-46.314942363499256, -11.630735642236061], [-46.06501054879777, -11.620447793730648]], [[-44.279799595874636, -10.610920789862519], [-44.165540128274245, -10.642901249293175]], [[-43.83696375267499, -11.353056698208036], [-44.15606171907302, -11.610580864815006], [-44.00891741760472, -11.874597311017055], [-44.25207674554531, -12.128335128563265], [-44.66345498435999, -11.747494151333967], [-44.68537524517137, -11.407828298537083], [-44.982454713314326, -11.38291640157064], [-44.96010943919924, -10.930864316834686], [-44.58490437203909, -10.629350885235112], [-44.279799595874636, -10.610920789862519]], [[-38.89984002359819, -15.765922957178702], [-39.00614522781996, -16.343603513990956], [-39.51909501462319, -16.495340103662784]], [[-40.30701884374457, -16.696766535946836], [-39.91667828007854, -16.283842770827164], [-39.914797935276454, -15.999993391181988]], [[-39.75990307586619, -12.550579672413903], [-39.63511738366026, -12.582841923615831], [-39.67874686767374, -12.887261135792755], [-39.85569878107384, -12.795600355971601], [-39.75990307586619, -12.550579672413903]], [[-38.56855237729036, -12.314173324039643], [-38.644326055802765, -12.513071513839236], [-38.810844925153106, -12.393880485196178], [-38.56855237729036, -12.314173324039643]], [[-38.77083426359036, -11.398758827258007], [-38.68039362906268, -11.697365060948755], [-38.83385605821047, -11.772709547907255], [-38.886121084320564, -11.523852812457278], [-39.16058743865932, -11.630338242615778], [-39.05379254459024, -11.398850076070119], [-38.77083426359036, -11.398758827258007]], [[-39.60148313483876, -11.349055916597251], [-39.47720257653765, -11.484963855497483], [-39.64081047622244, -11.724827515277582], [-39.46725904876604, -11.872341933633265], [-39.53662421863277, -12.025503322820043], [-39.296683202767554, -11.990796792537878], [-39.15774605583579, -11.646139085450386], [-39.041707670772325, -12.053053394498534], [-38.86873077970171, -11.81595654036198], [-38.68028391447103, -11.946091261602419]], [[-38.68028391447103, -11.946091261602419], [-38.65816224958809, -12.192902777740926]], [[-38.65816224958809, -12.192902777740926], [-38.838371048784836, -12.51404776928905], [-39.12717933156085, -12.49827378470735], [-39.3800613236711, -12.433475924374363], [-39.719105787202295, -11.905506897325381], [-40.03548797998627, -12.154666961510998], [-40.27365469460841, -12.054279115588656], [-40.35662616186784, -11.829633195315637], [-40.03816487410961, -11.850125669064312], [-39.90729233017686, -11.716304931627235], [-39.96858407019863, -11.490866924468946], [-39.60148313483876, -11.349055916597251]], [[-39.222769858242316, -12.097519419785328], [-39.26372091029174, -12.199897115559395], [-39.07668140402353, -12.232523726188958], [-39.222769858242316, -12.097519419785328]], [[-39.961902498601376, -11.14997336937546], [-39.86184635502519, -11.312936847257674], [-39.982548088223666, -11.449546059503007], [-40.14482838622098, -11.181930794470532], [-39.99024031433902, -11.162555197764107]], [[-39.99024031433902, -11.162555197764107], [-39.981910425725516, -11.151159329639313]], [[-39.981910425725516, -11.151159329639313], [-39.961902498601376, -11.14997336937546]], [[-43.048714999397646, -14.332471998383994], [-42.91796480463199, -13.983040835566044]], [[-43.00234763823289, -13.73999891501785], [-42.77282501016606, -13.746556727311088]], [[-42.9516124767344, -13.956876152412462], [-43.13637284732897, -13.877767922651458], [-43.00234763823289, -13.73999891501785]], [[-43.58661676055499, -13.806293550307032], [-43.81428966663475, -13.708354141030725]], [[-38.95367573814474, -13.87410416647407], [-39.07151009271655, -14.634795488021325], [-38.89984002359819, -15.765922957178702]], [[-38.89984002359819, -15.765922957178702], [-39.35590893744745, -15.849755898515866]], [[-39.44418811079265, -14.24153980431845], [-38.988238650293454, -14.08059972999348], [-38.95367573814474, -13.87410416647407]], [[-41.94174238510294, -11.228233860404316], [-41.72969261941881, -11.227972334855338], [-41.746471086471445, -11.392141097633498], [-41.94261596315613, -11.381248085430741], [-41.94174238510294, -11.228233860404316]], [[-41.36821306108385, -11.183036141304854], [-41.40294835528232, -11.444855834229315], [-41.618751058414546, -11.615333456273959], [-41.70021392283422, -11.4112431367613], [-41.36821306108385, -11.183036141304854]], [[-41.94174238510294, -11.228233860404316], [-42.24029068626612, -11.261231109528012], [-42.258279409666955, -11.14231022283849], [-42.089067178707296, -11.022217434986601], [-41.94174238510294, -11.228233860404316]], [[-40.777675254009694, -12.382707626455726], [-40.68648769565061, -12.448522495916393], [-41.206777392862364, -12.504458016823946], [-41.06135297106272, -12.265315664586183], [-40.777675254009694, -12.382707626455726]], [[-40.35286548755215, -12.256524175550226], [-39.92568981883005, -12.5216021347307], [-40.35873961544087, -12.792217572283107], [-40.57537300615928, -12.437805747237405], [-40.35286548755215, -12.256524175550226]], [[-39.59306199201728, -16.469109319439497], [-39.51909501462319, -16.495340103662784]], [[-39.51909501462319, -16.495340103662784], [-39.337402607444346, -16.784534668639992], [-39.504626703559495, -16.872072415709397]], [[-39.660710202313965, -16.780886542679752], [-39.59306199201728, -16.469109319439497]], [[-39.5438809291615, -13.949032788932016], [-39.44418811079265, -14.24153980431845]], [[-39.44418811079265, -14.24153980431845], [-39.26495965446446, -14.292083318490313], [-39.550592548007614, -14.561758343073052], [-39.290776400710286, -14.692889635448296], [-39.159710787622714, -15.044798394530233], [-39.32910546224724, -15.112104217635476], [-39.340237098763055, -15.319360729913683], [-39.020194953034604, -15.435237771206118], [-39.35590893744745, -15.849755898515866]], [[-39.35590893744745, -15.849755898515866], [-39.644341444801796, -15.743197655647236]], [[-39.644341444801796, -15.743197655647236], [-39.91098321080648, -15.86712508435511]], [[-40.09363835842345, -14.520803650567984], [-39.69657168423578, -14.369579277861362], [-39.5438809291615, -13.949032788932016]], [[-39.59473676259148, -13.472912186048518], [-39.35464312637913, -13.668203759895562], [-39.59473676259148, -13.472912186048518]], [[-39.99970504215395, -13.635705721741601], [-39.68003801804008, -13.871453240274775], [-39.974114355792835, -13.939210033815982], [-39.79374804663502, -14.06577082406426], [-40.10004216811154, -14.268292582036963], [-40.09363835842345, -14.520803650567984]], [[-40.09363835842345, -14.520803650567984], [-40.165725885840914, -14.478959174226475]], [[-40.21172252847185, -14.450753214389294], [-40.23784865229345, -14.441903166897589]], [[-40.37583441722455, -14.405526749359922], [-40.37590853754892, -14.405493886333716]], [[-40.38790532636966, -14.2657434635899], [-40.175399415550544, -14.134244116472757], [-40.512824506745574, -13.947914851589076], [-40.53369486302745, -13.721047354951452], [-39.99970504215395, -13.635705721741601]], [[-40.15063783306948, -13.337237159867016], [-40.09782013938786, -13.668696232245281], [-40.23491744248594, -13.534144043812546], [-40.15063783306948, -13.337237159867016]], [[-40.130853355997544, -13.11640793447856], [-39.926931748401444, -13.285564851736467], [-40.15064150949803, -13.337228390577707], [-40.130853355997544, -13.11640793447856]], [[-38.8089677144884, -12.921090203849758], [-38.9206390375615, -13.213984628287903]], [[-39.1713228284857, -13.233274054653862], [-39.311582021992706, -13.162480018537963], [-39.12299134347569, -13.108486185189236]], [[-38.95684342738224, -13.062026659702553], [-38.8089677144884, -12.921090203849758]], [[-39.211583039325774, -12.64867492161028], [-39.152971540704016, -13.040557642721012]], [[-39.201560494421244, -13.078009519923341], [-39.356239474272286, -12.919262648352515], [-39.211583039325774, -12.64867492161028]], [[-41.580793096723994, -12.711193005952396], [-41.437968927024315, -12.7107015570312], [-41.18510248599091, -13.229951245853272]], [[-41.60519754313208, -13.424854230738106], [-41.699664418178315, -12.994865029397545], [-41.580793096723994, -12.711193005952396]], [[-41.95982694205969, -12.0919601400484], [-41.72871193840518, -12.369168660405307], [-41.540610009044656, -12.356994620605235], [-41.64875734677412, -12.679637290928213], [-42.027990217474496, -12.657577874419303], [-42.071657039540696, -12.414615984540035], [-42.24925233332846, -12.389569529210348]], [[-42.24925233332846, -12.389569529210348], [-42.12412079154126, -12.277679202333275]], [[-42.12412079154126, -12.277679202333275], [-41.98487222287474, -12.291447221212252], [-41.95982694205969, -12.0919601400484]], [[-39.26501016938374, -17.840725635479657], [-39.49153812608358, -17.99766310976463]], [[-40.22369257325363, -17.73432058582631], [-40.48300009278, -17.48851297029728]], [[-40.270235653852296, -16.678176760549036], [-39.660710202313965, -16.780886542679752]], [[-39.660710202313965, -16.780886542679752], [-39.504626703559495, -16.872072415709397]], [[-39.504626703559495, -16.872072415709397], [-39.110909786357524, -16.89626101043723], [-39.13687440183213, -17.684921487736403]], [[-40.45135587367457, -17.270605287004344], [-40.54745632674803, -17.283608542200398]], [[-40.54775090148286, -17.283706278721752], [-40.4912055242155, -16.884490034187706], [-40.252121488515854, -16.860050635628284], [-40.30701884374457, -16.696766535946836]], [[-40.30701884374457, -16.696766535946836], [-40.270235653852296, -16.678176760549036]], [[-39.323020429848896, -13.205402663302209], [-39.1713228284857, -13.233274054653862]], [[-39.1713228284857, -13.233274054653862], [-38.9206390375615, -13.213984628287903]], [[-38.9206390375615, -13.213984628287903], [-38.94914681347461, -13.389603279667597], [-39.25113915834544, -13.527242301990611], [-39.47998238008273, -13.337592980231818], [-39.323020429848896, -13.205402663302209]], [[-39.10746581639427, -13.038356920735282], [-38.95684342738224, -13.062026659702553]], [[-38.95684342738224, -13.062026659702553], [-39.12299134347569, -13.108486185189236]], [[-39.12299134347569, -13.108486185189236], [-39.201560494421244, -13.078009519923341]], [[-39.201560494421244, -13.078009519923341], [-39.152971540704016, -13.040557642721012]], [[-39.152971540704016, -13.040557642721012], [-39.10746581639427, -13.038356920735282]], [[-41.37076899998931, -15.822488997269375], [-41.28990500041539, -15.911011997505625], [-41.4773980006172, -16.091683997018777], [-41.68176800029295, -16.110903996622085]], [[-41.38359500060875, -15.812213997378024], [-41.37076899998931, -15.822488997269375]], [[-44.107269214602525, -13.9850955157454], [-44.04568154546689, -14.28377401445914]], [[-44.411781952674914, -14.281584281289497], [-44.379594271458416, -14.044399900634858]], [[-41.90913628800922, -13.311448351060506], [-41.60519754313208, -13.424854230738106]], [[-41.60519754313208, -13.424854230738106], [-41.18510248599091, -13.229951245853272]], [[-41.18510248599091, -13.229951245853272], [-41.241173163310805, -13.505925011430065], [-40.85842408999969, -13.582517260962788], [-40.71476262269681, -13.841039226279236], [-40.9316793268394, -13.98152836204423], [-40.38790532636966, -14.2657434635899]], [[-40.38790532636966, -14.2657434635899], [-40.50522213729175, -14.337646589518442], [-40.37590853754892, -14.405493886333716]], [[-40.37590853754892, -14.405493886333716], [-40.37583441722455, -14.405526749359922]], [[-40.37583441722455, -14.405526749359922], [-40.23784865229345, -14.441903166897589]], [[-40.23784865229345, -14.441903166897589], [-40.21172252847185, -14.450753214389294]], [[-40.21172252847185, -14.450753214389294], [-40.165725885840914, -14.478959174226475]], [[-40.165725885840914, -14.478959174226475], [-40.20815707448935, -14.74246018119237], [-40.02465924143081, -14.818596394408019], [-40.13499313502513, -15.043577011769628], [-39.895542963736716, -15.101721024805386], [-39.76582400447421, -15.366945581573304], [-39.970621798157424, -15.507268121526522], [-39.91098321080648, -15.86712508435511]], [[-39.91098321080648, -15.86712508435511], [-39.914797935276454, -15.999993391181988]], [[-39.914797935276454, -15.999993391181988], [-40.819028270638114, -15.646342050844908], [-41.34254999998245, -15.801226997927586]], [[-42.277608609449715, -15.11365267393171], [-42.17825360971625, -14.819109138376007], [-42.479014465245314, -15.014245905624023]], [[-42.52423486344816, -14.40974798448184], [-42.59970013835067, -14.14178382206569], [-42.91410144842308, -13.982920008951226]], [[-42.91410144842308, -13.982920008951226], [-42.91796480463199, -13.983040835566044]], [[-42.91796480463199, -13.983040835566044], [-42.9516124767344, -13.956876152412462]], [[-42.9516124767344, -13.956876152412462], [-42.80760502675054, -13.97402418866534], [-42.77282501016606, -13.746556727311088]], [[-42.77282501016606, -13.746556727311088], [-42.719694485512036, -13.562737580874625]], [[-42.358414142298784, -13.626291159009725], [-42.05807208935539, -13.708880319970717], [-41.90913628800922, -13.311448351060506]], [[-41.90913628800922, -13.311448351060506], [-42.176742962717526, -13.226319459675267]], [[-42.176742962717526, -13.226319459675267], [-42.46302839084751, -13.439543412598368]], [[-42.68040688247163, -13.47860370839436], [-43.11651793805237, -13.323909154983482], [-43.439463916426575, -13.876172239357288], [-43.421087457520116, -14.496654082819646], [-43.048714999397646, -14.332471998383994]], [[-43.048714999397646, -14.332471998383994], [-42.9550750141006, -14.396148266529224]], [[-42.835360571033505, -14.561719349368445], [-42.80523833218325, -14.656824843791469]], [[-43.78318673328107, -14.339233714864008], [-43.58661676055499, -13.806293550307032]], [[-43.58661676055499, -13.806293550307032], [-43.432346758196275, -13.258639018375959], [-43.70606799813959, -13.187841878699714]], [[-43.22214152271306, -12.690841247325636], [-43.222133589793316, -12.69084364941483]], [[-43.222133589793316, -12.69084364941483], [-43.2872361368382, -12.842562127640008], [-42.90948760526874, -13.181065605793037], [-42.888625884277076, -12.541645430392236]], [[-42.888625884277076, -12.541645430392236], [-42.63925355310897, -12.50080086077105], [-42.58109297725906, -12.691151608759697], [-42.2802236140285, -12.708635265704913], [-41.90913628800922, -13.311448351060506]], [[-42.732516070460235, -14.31770053934838], [-42.835360571033505, -14.561719349368445]], [[-42.835360571033505, -14.561719349368445], [-42.9550750141006, -14.396148266529224]], [[-42.9550750141006, -14.396148266529224], [-42.732516070460235, -14.31770053934838]], [[-44.20984273325547, -14.244597847312775], [-44.04568154546689, -14.28377401445914]], [[-44.04568154546689, -14.28377401445914], [-43.78318673328107, -14.339233714864008]], [[-43.78318673328107, -14.339233714864008], [-43.88350757071777, -14.653232194310249], [-43.529757037856996, -14.8159448422806], [-42.80523833218325, -14.656824843791469]], [[-42.80523833218325, -14.656824843791469], [-42.52423486344816, -14.40974798448184]], [[-42.52423486344816, -14.40974798448184], [-42.323938568709934, -14.549600166414507], [-42.61345872334135, -14.899643185684454], [-42.479014465245314, -15.014245905624023]], [[-42.479014465245314, -15.014245905624023], [-42.277608609449715, -15.11365267393171]], [[-42.277608609449715, -15.11365267393171], [-41.80071005702348, -15.101097119236613], [-41.356422745813006, -15.500286133198415], [-41.34254999998245, -15.801226997927586]], [[-41.34254999998245, -15.801226997927586], [-41.38359500060875, -15.812213997378024]], [[-41.38359500060875, -15.812213997378024], [-41.68176800029295, -16.110903996622085]], [[-41.68176800029295, -16.110903996622085], [-41.95113200064128, -16.402663996446222], [-42.46786900075375, -16.488522997038615], [-42.3996050003704, -16.640923996844947], [-43.30736000006391, -17.526952996483544], [-43.564547000044, -17.545815996710814], [-43.76005600028412, -17.92523699659006], [-43.95644800077457, -17.555259996951236], [-44.10404300018428, -17.865835996633905], [-44.46823600019121, -17.6047989962766], [-44.60974700052361, -17.782918996814203], [-45.006668000727586, -17.72143299693522], [-44.98752400013245, -17.51885799639939], [-44.74477100028139, -17.463704996288527], [-44.84093500034993, -16.99181099658017], [-44.60902300041107, -16.88348699692733], [-44.674888000780584, -16.67954999653506], [-45.00746700070147, -16.75834899620918], [-45.104707000027986, -16.565412996812313], [-45.460331000575195, -16.963556996757973], [-45.99153400049369, -16.694062996709874]], [[-46.23085200021961, -16.237744996734193], [-45.99660700061253, -16.015221996298067], [-45.906118000545234, -16.10701999647563]], [[-45.36600300063793, -15.889370997773256], [-45.09419200076019, -15.58676199766802], [-45.60936262018873, -14.997660237030288], [-44.411781952674914, -14.281584281289497]], [[-44.411781952674914, -14.281584281289497], [-44.20984273325547, -14.244597847312775]], [[-43.31152600062438, -15.327135996728828], [-43.632984000311296, -15.80245999723104], [-43.53241800049028, -16.084238996332545], [-43.29617700056809, -16.133338996997054], [-43.31152600062438, -15.327135996728828]], [[-44.26778700056957, -16.124079996294768], [-44.475908000553716, -15.993561996588824], [-44.51491000049606, -16.262794996291973], [-44.70420400011449, -16.381214996574784], [-44.57822600022968, -16.504357997023874], [-44.30933500011014, -16.36133799635138], [-44.26778700056957, -16.124079996294768]], [[-45.03197100026142, -16.380628996530902], [-44.66134600041755, -16.075626996688527], [-45.079560000493586, -16.121652996788328], [-45.03197100026142, -16.380628996530902]], [[-44.170951000088564, -15.810607997061368], [-44.05468900039699, -15.473486996327779], [-44.27494200047289, -15.73455699640823], [-44.170951000088564, -15.810607997061368]], [[-42.62352553917225, -13.406716527445724], [-42.46302839084751, -13.439543412598368]], [[-42.46302839084751, -13.439543412598368], [-42.358414142298784, -13.626291159009725]], [[-42.358414142298784, -13.626291159009725], [-42.719694485512036, -13.562737580874625]], [[-42.719694485512036, -13.562737580874625], [-42.68040688247163, -13.47860370839436]], [[-42.68040688247163, -13.47860370839436], [-42.62352553917225, -13.406716527445724]], [[-40.39594516653614, -20.62216130889726], [-40.39594516653614, -20.62216130889726]], [[-40.38146280536415, -20.615020504792426], [-40.38146280536415, -20.615020504792426]], [[-40.37643858717104, -20.61404964347622], [-40.37643858717104, -20.61404964347622]], [[-40.373913689265294, -20.612940607622875], [-40.373913689265294, -20.612940607622875]], [[-40.3811939953066, -20.612886165364216], [-40.3811939953066, -20.612886165364216]], [[-40.38803496813921, -20.610739635625634], [-40.38803496813921, -20.610739635625634]], [[-40.373376547589544, -20.611399358493543], [-40.373376547589544, -20.611399358493543]], [[-40.39125060203361, -20.59877562169754], [-40.39125060203361, -20.59877562169754]], [[-40.35707160776843, -20.524688944539093], [-40.35707160776843, -20.524688944539093]], [[-41.774605523226285, -20.50206239666221], [-41.596056203430976, -20.678245344746813], [-41.733772394780146, -20.94334162671464], [-41.774605523226285, -20.50206239666221]], [[-29.30279135333825, -20.515797322288563], [-29.30279135333825, -20.515797322288563]], [[-28.840787191875336, -20.475937922197318], [-28.840787191875336, -20.475937922197318]], [[-28.83761406803478, -20.464644070467443], [-28.83761406803478, -20.464644070467443]], [[-28.842263655643137, -20.459494785356014], [-28.842263655643137, -20.459494785356014]], [[-40.310861014624095, -20.42152030851537], [-40.310861014624095, -20.42152030851537]], [[-40.29626442336439, -20.3820737826789], [-40.29626442336439, -20.3820737826789]], [[-40.27828577866569, -20.36531851903436], [-40.27828577866569, -20.36531851903436]], [[-40.27955529853813, -20.36314336387511], [-40.27955529853813, -20.36314336387511]], [[-40.2806295872856, -20.354509943279197], [-40.2806295872856, -20.354509943279197]], [[-40.25287027034665, -20.35363618086501], [-40.25287027034665, -20.35363618086501]], [[-40.25114153505376, -20.352269286898036], [-40.25114153505376, -20.352269286898036]], [[-40.271512565252635, -20.33549896950177], [-40.271512565252635, -20.33549896950177]], [[-40.27082407037449, -20.333378601041545], [-40.27082407037449, -20.333378601041545]], [[-40.2686560378458, -20.332493529652652], [-40.2686560378458, -20.332493529652652]], [[-40.26876254005913, -20.321535775255768], [-40.26876254005913, -20.321535775255768]], [[-40.27095870248212, -20.321839534766696], [-40.27095870248212, -20.321839534766696]], [[-40.857849133630566, -18.94036766533543], [-40.65505266784629, -19.178913452293955], [-40.82041583102574, -19.356849826558232], [-40.96426373498332, -19.122142226482538], [-40.857849133630566, -18.94036766533543]], [[-38.65483855945189, -18.042418703260523], [-38.65483855945189, -18.042418703260523]], [[-38.681658638835074, -18.009367714248583], [-38.681658638835074, -18.009367714248583]], [[-38.64740497835703, -17.9955048690544], [-38.64740497835703, -17.9955048690544]], [[-38.65661809834654, -17.981899596888866], [-38.65661809834654, -17.981899596888866]], [[-38.64273105779205, -17.97204647796252], [-38.64273105779205, -17.97204647796252]], [[-38.65349759114088, -17.97141327790041], [-38.65349759114088, -17.97141327790041]], [[-38.651339536590285, -17.946505713867566], [-38.651339536590285, -17.946505713867566]], [[-40.20533237139176, -17.73370805578213], [-40.01964263150222, -17.98470002818368], [-39.49153812608358, -17.99766310976463]], [[-39.49153812608358, -17.99766310976463], [-39.72856116206793, -18.500385404262943], [-39.706171983050524, -19.402049178826474], [-40.139667383842664, -19.949165909878786], [-40.42300216961439, -20.63616287181901], [-40.92607799930016, -21.19021252778589], [-41.01769268526914, -21.0002883282437], [-41.233273749583816, -21.075348722965145], [-41.15547920540098, -21.244990513301502], [-41.54828832444656, -21.183299473391912], [-41.58026820921043, -20.911702850306256], [-41.09202908077742, -20.953281420501128], [-41.054749640483465, -20.62781996102234], [-41.39145089434328, -20.624199694260426], [-41.34786745561854, -20.198242764292104], [-41.577039937143354, -20.499668442744394], [-41.847498297308505, -20.32800618153999], [-41.38243531673646, -20.189078680736486], [-41.17423937264891, -19.762658995616107], [-40.995767214685145, -19.80398413146247], [-40.85120188735715, -19.560372861818053], [-40.74670789075651, -19.8310698813699], [-40.370957889295084, -19.618360460266956], [-40.530491524664114, -19.341942229949893], [-40.204909545239275, -18.90022915794924], [-40.7381492254064, -18.93660399268009], [-40.68228364837165, -18.690817408696432], [-40.8052036826038, -18.585883774016907], [-40.652627390541625, -18.51075062773924], [-40.91447345338713, -18.426324602398438], [-40.98782094448097, -18.678135946216912], [-41.1589206545645, -18.308243451374153], [-40.77149605180131, -18.155940010023414], [-40.88271703935982, -17.97055107447244], [-40.22235060939306, -17.980417386453155], [-40.22369257325363, -17.73432058582631]], [[-40.22369257325363, -17.73432058582631], [-40.20533237139176, -17.73370805578213]], [[-40.886695989028624, -20.674247003896085], [-40.98670439299332, -20.861557500178435], [-40.82804346423444, -20.890831245765355], [-40.886695989028624, -20.674247003896085]], [[-40.18214304306696, -17.243964052199203], [-39.7679100008458, -17.627358332421068], [-39.13687440183213, -17.684921487736403]], [[-39.13687440183213, -17.684921487736403], [-39.26501016938374, -17.840725635479657]], [[-39.26501016938374, -17.840725635479657], [-39.85125893335305, -17.765949479584776], [-40.32364078019782, -17.404895779016954]], [[-40.32364078019782, -17.404895779016954], [-40.48300009278, -17.48851297029728]], [[-40.48300009278, -17.48851297029728], [-40.623475114584835, -17.405980698650296], [-40.54775090148286, -17.283706278721752]], [[-40.54775090148286, -17.283706278721752], [-40.54745632674803, -17.283608542200398]], [[-40.54745632674803, -17.283608542200398], [-40.45135587367457, -17.270605287004344]], [[-40.45135587367457, -17.270605287004344], [-40.18214304306696, -17.243964052199203]], [[-51.22210727313211, -19.158814398665527], [-51.09258694533122, -19.307197116054], [-51.46447606641726, -19.12433819375258], [-51.22210727313211, -19.158814398665527]], [[-49.64348395452083, -18.443028780054135], [-49.42336501458374, -18.526314465939834], [-49.75770308662811, -18.609709373588657], [-49.7474503188771, -18.365762528218056], [-49.64348395452083, -18.443028780054135]], [[-53.164510379350475, -16.537717610878985], [-52.91437438167236, -16.80915145667433], [-52.88574568021892, -17.279709920876087], [-53.183123733173716, -17.53694086802659], [-53.0700586947529, -17.665387393613287], [-53.24196981365594, -17.504191353348233], [-53.532434764552704, -17.715778824333256], [-53.397601849145985, -17.89281439986462], [-53.472578536770015, -18.039148774596242], [-53.948914883415114, -17.92342377718552], [-53.70460746746062, -17.66350954532919], [-53.68435982604507, -17.224115496632805], [-53.265858811834676, -16.923083511694642], [-53.3622910481933, -16.853918632538807], [-53.164510379350475, -16.537717610878985]], [[-46.8062022274508, -15.87061771033899], [-46.95254574019373, -15.916628226811156]], [[-44.12152764908171, -12.848412213952486], [-43.686357023557775, -12.933187133979004]], [[-43.640244554542505, -13.184751280247326], [-43.70606799813959, -13.187841878699714]], [[-43.70606799813959, -13.187841878699714], [-43.85716466082039, -13.262054442058798]], [[-44.10649808821614, -13.229449975435955], [-44.20881385487547, -12.970070123437381]], [[-44.20881385487547, -12.970070123437381], [-44.25617766756528, -12.981262421023871]], [[-44.17144186355114, -12.852392626818244], [-44.12152764908171, -12.848412213952486]], [[-53.22749511200976, -11.258529850072478], [-52.95146030045248, -11.612098281910164], [-52.38944394078521, -11.709406373405386], [-52.109907348145555, -12.000978564209333], [-51.830330431704, -11.86020519771165], [-51.35989271137947, -12.325602902351989], [-50.99524964745325, -12.389056743873596], [-50.84285175840188, -12.89640971773423], [-50.67773174222606, -12.646991185694617], [-50.51106649921951, -12.860767998644178], [-50.19436743480924, -12.412246522758778], [-50.17095059509387, -12.608208016886408], [-49.79667661673244, -12.71848135103346], [-49.52315370338067, -12.53223504141397], [-49.55344557685186, -12.405977239058302], [-49.24028005218264, -12.883511932329782], [-49.11908272778561, -12.790361752892522], [-48.97562955246184, -12.957194012593561], [-48.84676993858176, -12.809802498286615], [-48.56768472736826, -13.311865608610901], [-48.555077593855856, -12.866947539897012], [-48.23308778367425, -12.82838446037448], [-48.312020428000324, -12.270412869058589], [-48.10104644933415, -12.12932689192246], [-48.342855455115114, -11.911473483614316], [-48.45782452827933, -11.301359031893753], [-47.870290370504165, -11.878298381864795], [-47.7996243753646, -12.153455941638356], [-47.561629076021006, -12.18694915697796], [-47.506281881703444, -12.447609608496577], [-47.23429246712362, -12.498262553973632], [-47.37112463839128, -12.701128888987], [-47.218346501589735, -12.825477431538161], [-47.462529979275075, -12.959759167751372], [-47.40004505923207, -13.118095397184788], [-47.571682881359834, -13.116750511426915], [-47.432867374030025, -13.288075393764359], [-46.454649870595006, -12.971152609505282], [-46.41762470281776, -12.823458178352212], [-46.364279399374766, -12.991359792220578], [-46.11427458040754, -12.91790552282157]], [[-46.212211132537675, -14.01018343431798], [-45.90730010361682, -14.353233289384775], [-46.03757491584963, -14.87465616295151]], [[-48.59274715016079, -15.364252679517506], [-49.18480238242398, -15.598406528338558], [-49.194585383008985, -16.347191436635455], [-48.99647295516269, -16.48559807439159], [-48.759500202072616, -16.28652543949738], [-48.41154737810899, -16.286672672905468]], [[-47.32257758408821, -16.20914941821104], [-47.46006975431567, -16.505096762205767], [-47.12593186416416, -16.98176826819099], [-47.54118523670928, -17.454303911696115], [-47.26579316342372, -17.610443785352345], [-47.28251454331149, -18.056551125633916], [-47.87029844012085, -18.47536506704415], [-48.27597879028889, -18.329999132653825], [-48.820142940044605, -18.37923967037443], [-49.09986551068471, -18.104787167393795], [-49.40628426380766, -18.3405920213047], [-49.80792592054473, -18.226580650576523], [-50.065201134125005, -18.412375893532612], [-50.05343477409548, -18.647066748231794], [-50.269959876547034, -18.684172253346787], [-50.30633638761418, -18.37855756068285], [-50.10788912778099, -18.325324731850856], [-50.11644742800638, -18.18120716168113], [-50.507403144139744, -18.018397938214207], [-50.34538196960216, -17.942337045917895], [-50.524431819672714, -17.431414527058735], [-51.05457560527992, -16.957215968741934], [-51.43201169618277, -17.339426576575192], [-51.688723582527246, -17.275728890176083], [-51.73044669805665, -17.46706714683131], [-51.23097203982775, -17.902003210279872], [-51.11324542853367, -18.20520102620634], [-51.23844327463735, -18.370407621914183], [-50.93828493520158, -18.87839315551969], [-50.829413576675165, -18.910729956022635], [-50.78423649162073, -18.65566423731468], [-50.352323640423606, -18.76029778801245], [-50.67883314463387, -18.913491797408483], [-50.67779993062226, -19.172514858673765], [-51.59019481064195, -18.49942389679535], [-51.92441961847055, -18.54123748142456], [-51.66461646817544, -18.766629645641615], [-51.69719921707019, -19.120251014272867], [-52.45520469803836, -18.687976228220293], [-52.87345732669422, -18.64619264047792], [-52.71631315312948, -17.975996972182486], [-52.2234219873348, -17.81267821083071], [-52.35248293513928, -17.43071768197541], [-52.5255079705164, -17.364529482349667], [-52.09875273844807, -17.400976570412354], [-52.49317898602135, -17.26150295179974], [-52.61645624176208, -16.96684982755744], [-52.82458916136068, -16.894406918644336], [-52.60614664135437, -16.486516663513157], [-52.68023262333685, -16.301832911559586], [-52.956269699387065, -16.570389456508167], [-53.20457982150151, -16.491662542892016], [-53.16813690539385, -16.260290510298773], [-52.82041308839325, -16.02647348726157], [-52.299753933497186, -16.16707731536576], [-51.85146930666315, -15.906629832300894], [-51.65115803371623, -15.17725477678647], [-51.34974633162784, -14.990210862940899], [-51.619070708746165, -14.990247608340383], [-51.35641476143206, -14.302189025503083], [-51.678957420848235, -14.537465757938321], [-51.74430178569884, -14.377470845003472], [-52.09423584670691, -14.68675449822149], [-52.338961454607386, -14.564831027929529], [-51.823030442201116, -14.047412888493966], [-52.0773088161489, -13.954524124888394], [-52.04143492987805, -13.756867080451343], [-53.09683047064965, -13.635830191510081], [-53.032836022364506, -14.128151908383813], [-52.68650457622516, -14.551427596906024], [-53.09873040358519, -14.88107522873878], [-53.35908367277324, -14.787944527717741], [-53.45478710214303, -14.264925078729334], [-52.812376883286504, -12.871949970214928], [-53.58676522043851, -11.859640214824026], [-53.54740765553885, -11.56899219523359], [-53.22749511200976, -11.258529850072478]], [[-49.697754498471284, -15.062474753706852], [-50.04425307461963, -15.10605237561657], [-50.13950869377118, -15.40040102628626], [-49.787789138557855, -15.280626435661418], [-49.464395067578266, -15.43244174928725], [-49.50598232342543, -15.178501054579954], [-49.77381054252248, -15.235603981838267], [-49.697754498471284, -15.062474753706852]], [[-49.237697612055115, -17.506062805653926], [-49.45502995406906, -17.89495065664744], [-48.89010648642517, -18.092212456239793], [-48.85019213865621, -17.68052964942376], [-49.237697612055115, -17.506062805653926]], [[-52.18524307570732, -10.488423422602807], [-51.81249471715745, -10.726785494255125], [-50.603486103600744, -10.660586219478375], [-50.670107545326914, -11.284584906767975], [-51.51610913442897, -11.169471436657432], [-51.39522168223482, -11.023807996641665], [-51.75589734558599, -10.935527549856488], [-52.14465968539611, -10.97996388042867], [-52.18524307570732, -10.488423422602807]], [[-49.34366282757736, -7.652970783474814], [-49.14844341982791, -7.807314797339984], [-49.27624391562415, -8.363683835440611], [-49.86791502765635, -9.087409799522561], [-50.24850646819891, -8.919373071509995], [-50.8652317553412, -8.995631403666323], [-50.87433842617736, -8.760202094051351], [-51.04737611681429, -8.67371347179926], [-50.83775352240707, -8.30490899565359], [-50.34556465518466, -8.186138463019631], [-49.90092088599005, -8.394923853353077], [-49.905252591134115, -8.055760839391155], [-49.34366282757736, -7.652970783474814]], [[-48.12217945801552, -6.637326748430667], [-47.73454124108537, -6.983687913566314], [-48.19737645615851, -7.1463366997788285], [-48.12217945801552, -6.637326748430667]], [[-48.348212774100205, -5.280141886538786], [-47.77901262633162, -5.700296919467235], [-47.900346328420255, -5.961414342597777], [-48.06694638856493, -5.877667382743482], [-48.23598734274162, -6.008672661214291], [-48.29763654349165, -5.765123455582966], [-48.132249109408804, -5.61813011521258], [-48.4417854514374, -5.408159693614948], [-48.348212774100205, -5.280141886538786]], [[-50.91908383035445, -5.150671942356212], [-50.72020385452424, -5.174657757049829], [-50.95636533279384, -5.540540247734214], [-50.848389186411794, -5.709728317507825], [-51.401644974835676, -6.045824802472623], [-51.147068763412676, -6.206993131927447], [-51.12525749683596, -6.623844418984675], [-51.3223984590216, -6.575369953460552], [-51.73100989309205, -6.798771634703144], [-51.65803859650396, -7.190021091899837], [-51.88593185087416, -7.72212685826787], [-52.178685676202974, -7.924986966375343], [-52.02512644942607, -8.406556709924189], [-51.77687611603989, -8.387216627445355], [-51.92215167665853, -8.85280796331682], [-51.563953758858815, -9.081871076488937], [-51.3042872686425, -9.77285997071101], [-53.13338819780705, -9.645329647445237], [-52.92588206610441, -9.45035568446724], [-53.084800188377926, -9.116126304485306], [-52.887939100608946, -8.572816812845588], [-53.09235335412393, -7.477566570940439], [-53.31449634782814, -7.210683467368085], [-53.235465610849246, -6.820147454041717], [-53.46452375346843, -6.676769150875543], [-53.18177386427237, -6.458710145856514], [-53.382744877174275, -6.081626940830631], [-52.70252319259123, -5.66764535085224], [-52.65804283570827, -5.297780193601], [-52.426380041505695, -5.153984546549509], [-52.109236939533105, -5.352630909988477], [-52.05107474220557, -5.1514006549162445], [-50.91908383035445, -5.150671942356212]], [[-46.4071590007872, -15.907112996667422], [-46.18412200003024, -16.02332799688952], [-46.23085200021961, -16.237744996734193]], [[-46.23085200021961, -16.237744996734193], [-46.26739000074787, -16.33281799685301], [-45.91843700026732, -16.374513998722023], [-45.99153400049369, -16.694062996709874]], [[-45.99153400049369, -16.694062996709874], [-46.202826000119785, -16.940994996821587], [-46.47160800060868, -16.712516996961767], [-46.38361800067014, -16.499990996187478], [-46.51060600036658, -16.311474996473862], [-46.30725000068696, -16.288840996814486], [-46.4071590007872, -15.907112996667422]], [[-45.579097000626064, -15.726664997591513], [-45.36600300063793, -15.889370997773256]], [[-45.36600300063793, -15.889370997773256], [-45.3489290001732, -16.32284399645323], [-45.906118000545234, -16.10701999647563]], [[-45.906118000545234, -16.10701999647563], [-45.579097000626064, -15.726664997591513]], [[-46.99558652709652, -14.082935502271539], [-46.558898204788306, -15.030147531883017], [-46.501113683149924, -14.703025896927556], [-46.28686475580378, -14.928145711355455], [-46.03757491584963, -14.87465616295151]], [[-46.03757491584963, -14.87465616295151], [-46.07708184285275, -15.264681802023517], [-45.811665490370046, -15.112837832399975], [-45.61010300055301, -15.237751997256794], [-45.84615200061427, -15.426201997524117], [-46.26390500011564, -15.3907529977526], [-46.25589900053842, -15.796405997738532], [-46.8062022274508, -15.87061771033899]], [[-46.8062022274508, -15.87061771033899], [-47.018286470444195, -15.547421273472935]], [[-47.018286470444195, -15.547421273472935], [-47.18134027443409, -15.600412704482665], [-47.135098655578474, -15.948459599330988], [-46.95254574019373, -15.916628226811156]], [[-46.95254574019373, -15.916628226811156], [-46.88977800045433, -16.115982997017625], [-47.32257758408821, -16.20914941821104]], [[-47.32257758408821, -16.20914941821104], [-47.308386987269614, -16.050264260587085], [-47.72454089324759, -16.09443576240045], [-47.649206346495646, -16.3814023415448], [-47.91949099181579, -17.004275982350634], [-48.41154737810899, -16.286672672905468]], [[-48.41154737810899, -16.286672672905468], [-48.65079865533363, -15.968169252808707], [-48.409719434104545, -15.976660197410126], [-48.25296005616161, -15.650098761848312], [-48.546777172428506, -15.60624087791416], [-48.59274715016079, -15.364252679517506]], [[-48.59274715016079, -15.364252679517506], [-48.60599102976215, -14.990279760902183], [-48.07762894052314, -14.89506291781936], [-47.771294226347436, -14.641000704918554], [-47.64634622539796, -14.830962705664263], [-47.373348639328185, -14.815096363406383], [-46.99558652709652, -14.082935502271539]], [[-47.135985490537905, -13.431624426026417], [-47.114811663427474, -14.09972763542197], [-47.45476247270989, -14.146333044434414], [-47.390959061111744, -14.314599144534839], [-47.70523712719165, -14.462046540915082], [-47.932095784392914, -14.176976408934081], [-47.26395090401098, -13.97681443693665], [-47.324177652476635, -13.632137002320746], [-47.135985490537905, -13.431624426026417]], [[-43.23460336175572, -12.636099690648166], [-43.22214152271306, -12.690841247325636]], [[-43.22214152271306, -12.690841247325636], [-43.4539924505911, -13.149144748031631], [-43.640244554542505, -13.184751280247326]], [[-43.640244554542505, -13.184751280247326], [-43.686357023557775, -12.933187133979004]], [[-43.686357023557775, -12.933187133979004], [-43.549639528441446, -12.88659771221461], [-43.53642204574078, -12.636858747233362]], [[-43.53642204574078, -12.636858747233362], [-43.459747939016154, -12.566306701592964]], [[-43.459747939016154, -12.566306701592964], [-43.23460336175572, -12.636099690648166]], [[-44.500570528107346, -12.222277077425133], [-44.31260000138889, -12.306573999690272]], [[-44.31260000138889, -12.306573999690272], [-44.17916829807842, -12.741215612510473]], [[-44.17916829807842, -12.741215612510473], [-44.17144186355114, -12.852392626818244]], [[-44.17144186355114, -12.852392626818244], [-44.25617766756528, -12.981262421023871]], [[-44.25617766756528, -12.981262421023871], [-44.34210616866471, -13.118305388882561], [-44.10649808821614, -13.229449975435955]], [[-44.10649808821614, -13.229449975435955], [-43.85716466082039, -13.262054442058798]], [[-43.85716466082039, -13.262054442058798], [-43.93313618568635, -13.65627663525845], [-43.81428966663475, -13.708354141030725]], [[-43.81428966663475, -13.708354141030725], [-44.107269214602525, -13.9850955157454]], [[-44.107269214602525, -13.9850955157454], [-44.192772732075866, -13.927197624670612]], [[-44.192772732075866, -13.927197624670612], [-44.379594271458416, -14.044399900634858]], [[-44.379594271458416, -14.044399900634858], [-44.7990813248432, -13.801122971048244], [-44.292275080330626, -13.563148703250022], [-44.29999751647216, -13.39596596965373], [-46.212211132537675, -14.01018343431798]], [[-46.212211132537675, -14.01018343431798], [-46.244282943303176, -13.433694122185955], [-46.041082774550375, -13.276669719431936], [-46.27938894344493, -13.347898304363184], [-46.32266496241806, -13.098283158041284], [-46.11427458040754, -12.91790552282157]], [[-46.11427458040754, -12.91790552282157], [-46.30522396751206, -12.948869698877445], [-46.261147290215206, -12.54971305241537], [-45.764716018729246, -12.411341174355641]], [[-45.764716018729246, -12.411341174355641], [-44.92726879711728, -12.293111273666284], [-44.73785170729042, -12.40884312121301], [-44.500570528107346, -12.222277077425133]], [[-44.01805170122498, -10.63640466644216], [-43.83696375267499, -11.353056698208036]], [[-43.83696375267499, -11.353056698208036], [-44.33850073532062, -11.493635786862], [-44.49569205404504, -11.40334405848148], [-44.15035739937446, -10.932026653707055], [-44.165540128274245, -10.642901249293175]], [[-44.165540128274245, -10.642901249293175], [-44.01805170122498, -10.63640466644216]]]}"
        state_geo = json.loads(state_geo)
        
        dataframe['str_id'] = dataframe[chart_options.get('id_field')].astype(str)
        dataframe['idx'] = dataframe[chart_options.get('id_field')]
        
        # Runs dataframe modifiers from viewconf
        dataframe = ViewConfReader().generate_columns(dataframe, options)

        dataframe = dataframe.set_index('idx')
        centroide = None  
        marker_tooltip = ''
        # for each_au in state_geo.get('features'):
        for each_au in state_geo.get('objects',{}).get('data',{}).get('geometries',[]):
            # TODO 2 - Add a mechanism to know the identifying property in each geo/topo json
            # each_au.get('properties').update(json.loads(dataframe.loc[int(each_au.get('properties').get(chart_options.get('id_field')))].to_json()), headers=options.get('headers'))
            # df_row = dataframe.loc[int(each_au.get('properties').get("id"))]
            try:
                df_row = dataframe.loc[int(each_au.get('properties').get("CodReg"))]
            except KeyError:
                continue
            each_au.get('properties').update(json.loads(df_row.to_json()), headers=options.get('headers'))
            if str(each_au.get('properties', {}).get(chart_options.get('id_field'))) == str(au):
                centroide = each_au.get('properties', {}).get('centroide')
                if centroide:
                    centroide.reverse()
                
                marker_tooltip = "".join([f"<tr style='text-align: left;'><th style='padding: 4px; padding-right: 10px;'>{hdr.get('text').encode('ascii', 'xmlcharrefreplace').decode()}</th><td style='padding: 4px;'>{str(df_row[hdr.get('value')]).encode('ascii', 'xmlcharrefreplace').decode()}</td></tr>" for hdr in options.get('headers')])
                marker_tooltip = f"<table>{marker_tooltip}</table>"
        state_geo = json.dumps(state_geo)
        
        # Creating map instance
        n = folium.Map(tiles=tiles_url, attr = tiles_attribution, control_scale = True)

        # Creating the choropleth layer
        color_scale = ViewConfReader.get_color_scale(
            options,
            dataframe[chart_options['value_field']].min(), 
            dataframe[chart_options['value_field']].max()
        )
        def get_color(feature):
            if feature is None:
                return '#8c8c8c' # MISSING -> gray
            value = None
            if chart_options['value_field'] in feature.get('properties',{}):
                value = feature.get('properties',{}).get(chart_options['value_field'])
            if value is None:
                return '#8c8c8c' # MISSING -> gray
            else:
                return color_scale(value)

        # chart = folium.GeoJson(
        #     data = state_geo,
        #     name = ViewConfReader.get_chart_title(options),
        #     style_function = lambda feature: {
        #         'fillColor': get_color(feature),
        #         'fillOpacity': 0.8,
        #         'color' : 'black',
        #         'stroke' : 'black',
        #         'lineOpacity': 0.2,
        #         'weight' : 0.2,
        #     }    
        # )
        
        chart = folium.TopoJson(
            json.loads(state_geo),
            'objects.data',
            name=ViewConfReader.get_chart_title(options),
            style_function = lambda feature: {
                'fillColor': get_color(feature),
                'fillOpacity': 0.8,
                'color' : 'black',
                'stroke' : 'black',
                'lineOpacity': 0.2,
                'weight' : 0.2,
            }
        )


        # Adding tooltip to choropleth
        # folium.features.GeoJsonTooltip(
        #     fields = [hdr.get('value') for hdr in options.get('headers')],
        #     aliases = [hdr.get('text') for hdr in options.get('headers')],
        #     localize=True,
        #     sticky=False,
        #     labels=True
        # ).add_to(chart)

        # Adding marker to current analysis unit
        if np.issubdtype(dataframe.index.dtype, np.number):
            au = int(au)
        au_row = dataframe.loc[au]
        au_title = 'Analysis Unit'
        if len(options.get('headers', [])) > 0:
            au_title = au_row[options.get('headers', [])[0]['value']]

        if 'latitude' in list(dataframe.columns):
            centroide = [au_row['latitude'], au_row['longitude']]
        
        if centroide:
            marker_layer = folium.map.FeatureGroup(name = au_title)
            folium.map.Marker(
                centroide,
                tooltip=marker_tooltip,
                icon=folium.Icon(color=ViewConfReader.get_marker_color(options))
            ).add_to(marker_layer)
            marker_layer.add_to(n)
        
        chart.add_to(n)
        folium.LayerControl().add_to(n)

        n.get_root().header.add_child(folium.Element(style_statement))
        #n.fit_bounds(n.get_bounds())
        return n
